<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Music API - Gerenciador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .card-album:hover .btn-actions { opacity: 1; }
        .btn-actions { opacity: 0; transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">
    
    <!-- Notifica√ß√µes WebSocket -->
    <div id="wsNotifications" class="fixed top-4 right-4 z-50 max-w-md p-4 bg-indigo-600 text-white rounded-lg shadow-2xl hidden animate-bounce"></div>

    <nav class="bg-indigo-700 text-white p-4 shadow-lg mb-8">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">üéµ Music SEPLAG Manager</h1>
            <div id="authInfo" class="text-sm"></div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 space-y-12">
        
        <!-- SE√á√ÉO 1: LOGIN (Minimizada ap√≥s login) -->
        <section id="loginSection" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">üîë Autentica√ß√£o</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input id="user" type="text" placeholder="Usu√°rio" class="border p-2 rounded" value="admin">
                <input id="pass" type="password" placeholder="Senha" class="border p-2 rounded" value="admin123">
                <button onclick="login()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition">Entrar</button>
                <button onclick="logout()" class="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200 transition">Sair</button>
            </div>
            <p id="loginStatus" class="mt-2 text-xs font-mono"></p>
        </section>

        <!-- SE√á√ÉO 2: ARTISTAS -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formul√°rio Artista -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-fit">
                <h2 class="text-lg font-bold mb-4">üë§ Novo/Editar Artista</h2>
                <input id="artistId" type="hidden">
                <div class="space-y-3">
                    <input id="artistName" type="text" placeholder="Nome do Artista" class="w-full border p-2 rounded">
                    <select id="artistType" class="w-full border p-2 rounded">
                        <option value="SOLO">Solo</option>
                        <option value="DUPLA">Dupla</option>
                        <option value="BANDA">Banda</option>
                    </select>
                    <button onclick="saveArtist()" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Salvar Artista</button>
                </div>
            </div>

            <!-- Lista de Artistas -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Listagem de Artistas</h2>
                    <button onclick="getArtists()" class="text-indigo-600 hover:underline text-sm">Atualizar</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b text-gray-400 text-sm">
                                <th class="pb-2">ID</th>
                                <th class="pb-2">Nome</th>
                                <th class="pb-2">Tipo</th>
                                <th class="pb-2 text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="artistTableBody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SE√á√ÉO 3: √ÅLBUNS E CAPAS (GALERIA) -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">üíø √Ålbuns e Capas</h2>
                <button onclick="openAlbumModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Novo √Ålbum</button>
            </div>
            
            <div id="albumGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Cards de √°lbuns aparecer√£o aqui -->
            </div>
        </section>
    </div>

    <!-- MODAL DE √ÅLBUM -->
    <div id="albumModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Novo √Ålbum</h2>
            <div class="space-y-4">
                <input id="formAlbumId" type="hidden">
                <input id="albumTitle" type="text" placeholder="T√≠tulo do √Ålbum" class="w-full border p-2 rounded">
                <input id="albumYear" type="number" placeholder="Ano de Lan√ßamento" class="w-full border p-2 rounded">
                <select id="albumArtistId" class="w-full border p-2 rounded">
                    <option value="">Selecione o Artista Principal</option>
                </select>
                <div class="flex gap-2">
                    <button onclick="saveAlbum()" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">Salvar</button>
                    <button onclick="closeAlbumModal()" class="flex-1 bg-gray-200 py-2 rounded">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api/v1';
        let token = '';
        let stompClient = null;

        // --- AUTH ---
        async function login() {
            const username = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    token = data.accessToken;
                    document.getElementById('authInfo').innerText = `Logado como: ${username}`;
                    document.getElementById('loginStatus').innerText = "‚úÖ Conectado";
                    connectWebSocket();
                    loadAll();
                } else { alert("Erro no login: " + data.message); }
            } catch (e) { console.error(e); }
        }

        function logout() {
            token = '';
            location.reload();
        }

        function loadAll() {
            getArtists();
            getAlbums();
            updateArtistSelect();
        }

        // --- ARTISTAS (CRUD) ---
        async function getArtists() {
            const res = await fetch(`${API_URL}/artists?size=100`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            const tbody = document.getElementById('artistTableBody');
            tbody.innerHTML = data.content.map(a => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3">${a.id}</td>
                    <td class="font-semibold">${a.name}</td>
                    <td><span class="px-2 py-1 bg-gray-100 rounded text-xs">${a.type}</span></td>
                    <td class="text-right space-x-2">
                        <button onclick="editArtist(${a.id}, '${a.name}', '${a.type}')" class="text-blue-600 hover:underline">Editar</button>
                        <button onclick="deleteArtist(${a.id})" class="text-red-600 hover:underline">Excluir</button>
                    </td>
                </tr>
            `).join('');
            updateArtistSelect(data.content);
        }

        async function saveArtist() {
            const id = document.getElementById('artistId').value;
            const name = document.getElementById('artistName').value;
            const type = document.getElementById('artistType').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/artists/${id}` : `${API_URL}/artists`;

            await fetch(url, {
                method,
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, type })
            });
            document.getElementById('artistId').value = '';
            document.getElementById('artistName').value = '';
            getArtists();
        }

        function editArtist(id, name, type) {
            document.getElementById('artistId').value = id;
            document.getElementById('artistName').value = name;
            document.getElementById('artistType').value = type;
        }

        async function deleteArtist(id) {
            if(!confirm("Excluir artista?")) return;
            await fetch(`${API_URL}/artists/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
            getArtists();
        }

        // --- √ÅLBUNS E CAPAS ---
        async function getAlbums() {
            try {
                const res = await fetch(`${API_URL}/albums?size=100`, { 
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const grid = document.getElementById('albumGrid');
                
                grid.innerHTML = data.content.map(album => {
                    // L√≥gica para pegar a primeira capa do Set/Array 'covers'
                    let coverUrl = 'https://placehold.co/400x400?text=Sem+Capa';
                    
                    if (album.covers && album.covers.length > 0) {
                        // Procura a primeira capa que tenha uma URL v√°lida
                        const firstCover = album.covers.find(c => c.url) || album.covers[0];
                        if (firstCover.url) {
                            coverUrl = firstCover.url;
                        }
                    }
                    
                    return `
                    <div class="card-album bg-white rounded-xl overflow-hidden shadow-md border border-gray-100 relative group">
                        <img src="${coverUrl}" class="w-full h-48 object-cover bg-gray-200" 
                            onerror="this.src='https://placehold.co/400x400?text=Erro+na+Imagem'">
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 truncate">${album.title}</h3>
                            <p class="text-xs text-gray-500">${album.releaseYear} ‚Ä¢ ID: ${album.id}</p>
                            
                            <div class="mt-4 flex flex-col gap-2">
                                <!-- Input de arquivo escondido -->
                                <input type="file" id="file-${album.id}" class="hidden" onchange="uploadCover(${album.id})">
                                
                                <button onclick="document.getElementById('file-${album.id}').click()" 
                                        class="text-xs bg-indigo-50 text-indigo-600 py-2 rounded font-semibold hover:bg-indigo-100 transition">
                                    üì∑ Alterar Capa
                                </button>
                                
                                <div class="flex justify-between mt-2">
                                    <button onclick="deleteAlbum(${album.id})" class="text-xs text-red-500 hover:underline">Excluir √Ålbum</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (error) {
                console.error("Erro ao carregar √°lbuns:", error);
            }
        }

        async function uploadCover(albumId) {
            const fileInput = document.getElementById(`file-${albumId}`);
            if (!fileInput.files[0]) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const res = await fetch(`${API_URL}/albums/${albumId}/covers`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if(res.ok) {
                alert("Capa atualizada!");
                getAlbums();
            }
        }

        async function deleteAlbum(id) {
            if(!confirm("Excluir √°lbum?")) return;
            await fetch(`${API_URL}/albums/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }});
            getAlbums();
        }

        // --- AUXILIARES ---
        function openAlbumModal() { document.getElementById('albumModal').classList.remove('hidden'); }
        function closeAlbumModal() { document.getElementById('albumModal').classList.add('hidden'); }

        async function updateArtistSelect(artists = []) {
            const select = document.getElementById('albumArtistId');
            if(artists.length === 0) {
                const res = await fetch(`${API_URL}/artists?size=100`, { headers: { 'Authorization': `Bearer ${token}` }});
                const data = await res.json();
                artists = data.content;
            }
            select.innerHTML = '<option value="">Selecione o Artista</option>' + 
                artists.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        async function saveAlbum() {
            const title = document.getElementById('albumTitle').value;
            const releaseYear = document.getElementById('albumYear').value;
            const artistId = document.getElementById('albumArtistId').value;

            const res = await fetch(`${API_URL}/albums`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, releaseYear, artistIds: [parseInt(artistId)] })
            });

            if(res.ok) {
                closeAlbumModal();
                getAlbums();
            }
        }

        // --- WEBSOCKET ---
        function connectWebSocket() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            stompClient.connect({}, function() {
                stompClient.subscribe('/topic/albums', function(msg) {
                    const note = JSON.parse(msg.body);
                    showNotification(note.message);
                    getAlbums(); // Atualiza a grade automaticamente quando algu√©m cria um √°lbum
                });
            });
        }

        function showNotification(msg) {
            const el = document.getElementById('wsNotifications');
            el.innerText = "üîî " + msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>